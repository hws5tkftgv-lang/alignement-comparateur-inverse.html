<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Alignement">
<title>Alignement ‚Äì Comparateur invers√© (mils)</title>

<style>
:root{
  --bg:#0b1436;
  --card:#121c4a;
  --ok:#4caf50;
  --bad:#ff5252;
  --warn:#ffb300;
  --accent:#00a2ff;
  --muted:rgba(234,241,255,.75);
  --line:rgba(255,255,255,.12);
}

*{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html,body{ height:100%; }
body{
  margin:0;
  font-family:Arial, system-ui, sans-serif;
  background:var(--bg);
  color:#eaf1ff;
}

header{
  padding:14px 14px 10px;
  font-size:18px;
  font-weight:800;
  text-align:center;
}

.subhead{
  text-align:center;
  font-size:12px;
  color:var(--muted);
  padding:0 14px 10px;
}

.step{
  background:var(--card);
  margin:12px;
  padding:14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.06);
}

.step h2{
  margin:0 0 8px;
  font-size:16px;
}

.step p{
  margin:0 0 10px;
  font-size:13px;
  opacity:0.92;
  line-height:1.35;
}

.grid2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

label{
  display:block;
  font-size:12px;
  color:var(--muted);
  margin-bottom:6px;
}

input, select{
  width:100%;
  padding:10px;
  font-size:16px;
  border-radius:12px;
  border:none;
  outline:none;
}

button{
  width:100%;
  margin-top:10px;
  padding:12px;
  font-size:16px;
  border:none;
  border-radius:12px;
  background:var(--accent);
  color:white;
  font-weight:800;
}

button.secondary{
  background:rgba(255,255,255,.10);
}

.status{
  margin-top:10px;
  font-weight:800;
  font-size:14px;
  line-height:1.35;
}

.ok{ color:var(--ok); }
.bad{ color:var(--bad); }
.warn{ color:var(--warn); }

.locked{
  opacity:0.40;
  pointer-events:none;
}

hr.sep{
  border:none;
  height:1px;
  background:var(--line);
  margin:10px 0;
}

.small{
  margin-top:6px;
  font-size:12px;
  color:var(--muted);
  line-height:1.35;
}

.kpi{
  background:rgba(255,255,255,0.06);
  border-radius:12px;
  padding:10px;
  font-size:13px;
  line-height:1.35;
}

.kpi b{ color:#cfe2ff; }

#alignView{
  width:100%;
  height:240px;
  background:#000;
  border-radius:14px;
  display:block;
  touch-action:none;
}

.pillRow{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:8px;
}
.pill{
  padding:6px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.10);
  font-size:12px;
  color:#eaf1ff;
}
.pill.ok{ background:rgba(76,175,80,.18); }
.pill.bad{ background:rgba(255,82,82,.18); }
.pill.warn{ background:rgba(255,179,0,.18); }

footer{
  padding:14px;
  text-align:center;
  font-size:12px;
  color:var(--muted);
  opacity:.9;
}
</style>
</head>

<body>

<header>Alignement ‚Äì Comparateur invers√©</header>
<div class="subhead">iPhone-first ‚Ä¢ unit√©s: <b>mils</b> ‚Ä¢ s√©quence m√©tier: voilage ‚Üí pied boiteux (4 pattes) ‚Üí V ang ‚Üí V par ‚Üí H ang ‚Üí H par</div>

<!-- √âTAPE 1 -->
<div class="step" id="step1">
  <h2>1Ô∏è‚É£ V√©rification du voilage (runout)</h2>
  <p>Confirmer que les arbres/coupleur sont acceptables AVANT l‚Äôalignement.</p>

  <div class="grid2">
    <div>
      <label>Runout arbre moteur (mils)</label>
      <input id="runoutMotor" type="number" inputmode="decimal" placeholder="ex: 1.5">
    </div>
    <div>
      <label>Runout arbre pompe (mils)</label>
      <input id="runoutPump" type="number" inputmode="decimal" placeholder="ex: 1.0">
    </div>
  </div>

  <div class="small">Tol√©rance p√©dagogique par d√©faut: ‚â§ <b>2.0 mils</b> (√† ajuster selon ton cours).</div>

  <button id="btnStep1">Valider voilage</button>
  <div class="status" id="status1"></div>
</div>

<!-- √âTAPE 2 -->
<div class="step locked" id="step2">
  <h2>2Ô∏è‚É£ Pied boiteux ‚Äì mesures des 4 pattes (moteur mobile)</h2>
  <p>Entrer les lectures au comparateur (variation/√©cart) pour <b>chaque patte</b>. L‚Äôoutil calcule max/min et d√©termine si le pied boiteux est pr√©sent.</p>

  <div class="grid2">
    <div>
      <label>Patte AV gauche (mils)</label>
      <input id="sfFL" type="number" inputmode="decimal" placeholder="ex: 0.0">
    </div>
    <div>
      <label>Patte AV droite (mils)</label>
      <input id="sfFR" type="number" inputmode="decimal" placeholder="ex: 0.5">
    </div>
    <div>
      <label>Patte AR gauche (mils)</label>
      <input id="sfRL" type="number" inputmode="decimal" placeholder="ex: 2.0">
    </div>
    <div>
      <label>Patte AR droite (mils)</label>
      <input id="sfRR" type="number" inputmode="decimal" placeholder="ex: 0.0">
    </div>
  </div>

  <div class="kpi" id="sfKPI">
    <div><b>Œî (max-min)</b> : ‚Äî</div>
    <div><b>Patte max</b> : ‚Äî</div>
    <div><b>Patte min</b> : ‚Äî</div>
  </div>

  <div class="small">Tol√©rance p√©dagogique (pied boiteux): Œî ‚â§ <b>3.0 mils</b>.</div>

  <button id="btnStep2">Valider pied boiteux</button>
  <div class="status" id="status2"></div>
</div>

<!-- √âTAPE 3 -->
<div class="step locked" id="step3">
  <h2>3Ô∏è‚É£ Angularit√© verticale (12h‚Äì6h)</h2>
  <p>Entrer les lectures <b>A</b> (mils) au comparateur invers√© (12h et 6h). L‚Äôoutil indique si c‚Äôest acceptable et pr√©pare le calcul futur.</p>

  <div class="grid2">
    <div>
      <label>Lecture 12h (mils)</label>
      <input id="v12" type="number" inputmode="decimal" placeholder="ex: +1.0">
    </div>
    <div>
      <label>Lecture 6h (mils)</label>
      <input id="v6" type="number" inputmode="decimal" placeholder="ex: -1.0">
    </div>
  </div>

  <div class="kpi" id="kpiAngV">
    <div><b>ŒîV</b> (12h‚àí6h): ‚Äî</div>
  </div>

  <div class="small">Tol√©rance p√©dagogique: |ŒîV| ‚â§ <b>2.0 mils</b>.</div>

  <button id="btnStep3">Valider angularit√© V</button>
  <div class="status" id="status3"></div>
</div>

<!-- √âTAPE 4 -->
<div class="step locked" id="step4">
  <h2>4Ô∏è‚É£ Parall√©lisme vertical</h2>
  <p>Entrer les lectures <b>R</b> (mils) (ex: comparateur sur le plan vertical). L‚Äôoutil indique si c‚Äôest acceptable.</p>

  <div class="grid2">
    <div>
      <label>Lecture verticale (mils)</label>
      <input id="parV" type="number" inputmode="decimal" placeholder="ex: 1.0">
    </div>
    <div>
      <label>Tol√©rance par d√©faut (mils)</label>
      <input id="tolParV" type="number" inputmode="decimal" value="2.0">
    </div>
  </div>

  <button id="btnStep4">Valider parall√©lisme V</button>
  <div class="status" id="status4"></div>
</div>

<!-- √âTAPE 5 -->
<div class="step locked" id="step5">
  <h2>5Ô∏è‚É£ Angularit√© horizontale (3h‚Äì9h)</h2>
  <p>Entrer les lectures au comparateur invers√© (3h et 9h).</p>

  <div class="grid2">
    <div>
      <label>Lecture 3h (mils)</label>
      <input id="h3" type="number" inputmode="decimal" placeholder="ex: +0.5">
    </div>
    <div>
      <label>Lecture 9h (mils)</label>
      <input id="h9" type="number" inputmode="decimal" placeholder="ex: -0.5">
    </div>
  </div>

  <div class="kpi" id="kpiAngH">
    <div><b>ŒîH</b> (3h‚àí9h): ‚Äî</div>
  </div>

  <div class="small">Tol√©rance p√©dagogique: |ŒîH| ‚â§ <b>2.0 mils</b>.</div>

  <button id="btnStep5">Valider angularit√© H</button>
  <div class="status" id="status5"></div>
</div>

<!-- √âTAPE 6 -->
<div class="step locked" id="step6">
  <h2>6Ô∏è‚É£ Parall√©lisme horizontal</h2>
  <p>Entrer la lecture horizontale (mils).</p>

  <div class="grid2">
    <div>
      <label>Lecture horizontale (mils)</label>
      <input id="parH" type="number" inputmode="decimal" placeholder="ex: 0.8">
    </div>
    <div>
      <label>Tol√©rance par d√©faut (mils)</label>
      <input id="tolParH" type="number" inputmode="decimal" value="2.0">
    </div>
  </div>

  <button id="btnStep6">Valider parall√©lisme H</button>
  <div class="status" id="status6"></div>
</div>

<!-- Vue -->
<div class="step" id="view">
  <h2>üîß Vue moteur & pompe (p√©dagogique)</h2>
  <p>Moteur = mobile (bleu) ‚Ä¢ Pompe = fixe (orange). Indicateurs affich√©s selon les √©tapes.</p>

  <canvas id="alignView"></canvas>

  <div class="pillRow" id="pillRow">
    <span class="pill warn">Suivi: √©tape 1</span>
  </div>

  <hr class="sep">

  <button class="secondary" id="btnResetAll">R√©initialiser tout</button>
  <div class="small">Astuce: sur iPhone, utilise <b>Partager ‚Üí Sur l‚Äô√©cran d‚Äôaccueil</b> pour avoir une ic√¥ne.</div>
</div>

<footer>Version de base (cl√© en main). Prochaine √©tape: ajouter les distances (A,B,C) + calculs de corrections (shims & lat√©ral) + ‚Äúrapport‚Äù exportable.</footer>

<script>
(() => {
  "use strict";

  /* ===================== UTIL ===================== */
  const $ = (id)=>document.getElementById(id);
  const isNum = (x)=>Number.isFinite(x);

  function parseNum(id){
    const v = parseFloat($(id).value);
    return Number.isFinite(v) ? v : null;
  }

  function setStatus(step, cls, html){
    const el = $("status"+step);
    el.className = "status " + (cls || "");
    el.innerHTML = html;
  }

  function lock(step){
    const el = $("step"+step);
    if(el) el.classList.add("locked");
  }
  function unlock(step){
    const el = $("step"+step);
    if(el) el.classList.remove("locked");
  }

  function setPills(){
    const row = $("pillRow");
    row.innerHTML = "";

    const s = state.step;

    const mk = (txt, cls)=>{
      const span = document.createElement("span");
      span.className = "pill " + (cls||"");
      span.textContent = txt;
      row.appendChild(span);
    };

    mk("√âtape actuelle: " + s, "warn");

    if(state.runoutOK) mk("Voilage OK", "ok");
    else mk("Voilage non valid√©", "warn");

    if(state.softFootOK) mk("Pied boiteux OK", "ok");
    else mk("Pied boiteux √† v√©rifier", state.step>2 ? "warn":"warn");

    if(state.angVOK) mk("Ang V OK", "ok");
    if(state.parVOK) mk("Par V OK", "ok");
    if(state.angHOK) mk("Ang H OK", "ok");
    if(state.parHOK) mk("Par H OK", "ok");
  }

  /* ===================== STATE ===================== */
  const state = {
    step: 1,

    runoutOK:false,
    softFootOK:false,
    angVOK:false,
    parVOK:false,
    angHOK:false,
    parHOK:false,

    // valeurs calcul√©es pour affichage
    sfDelta:null,
    sfMaxKey:null,
    sfMinKey:null,

    angVDelta:null,
    angHDelta:null,

    parV:null,
    parH:null
  };

  /* ===================== TOL√âRANCES P√âDAGO ===================== */
  const TOL = {
    runout: 2.0,     // mils
    softFoot: 3.0,   // Œî max-min (mils)
    angDelta: 2.0    // |Œî| (mils)
  };

  /* ===================== STEP 1 (VOILAGE) ===================== */
  $("btnStep1").addEventListener("click", () => {
    const m = parseNum("runoutMotor");
    const p = parseNum("runoutPump");

    if(m === null || p === null){
      setStatus(1, "bad", "‚ùå Entre les deux valeurs de voilage (mils).");
      return;
    }
    if(m < 0 || p < 0){
      setStatus(1, "bad", "‚ùå Le voilage ne peut pas √™tre n√©gatif.");
      return;
    }

    const ok = (m <= TOL.runout) && (p <= TOL.runout);

    if(ok){
      state.runoutOK = true;
      state.step = Math.max(state.step, 2);
      setStatus(1, "ok", `‚úî Voilage acceptable (‚â§ ${TOL.runout.toFixed(1)} mils).`);
      unlock(2);
    }else{
      state.runoutOK = false;
      setStatus(1, "bad", `‚õî Voilage trop √©lev√©. Cible: ‚â§ ${TOL.runout.toFixed(1)} mils.`);
      // on garde step2 verrouill√©
      lock(2);
      lock(3); lock(4); lock(5); lock(6);
    }

    drawAlignmentView();
    setPills();
  });

  /* ===================== STEP 2 (PIED BOITEUX 4 PATTES) ===================== */
  function softFootCompute(){
    const vals = {
      "AV G": parseNum("sfFL"),
      "AV D": parseNum("sfFR"),
      "AR G": parseNum("sfRL"),
      "AR D": parseNum("sfRR")
    };
    for(const k of Object.keys(vals)){
      if(vals[k] === null) return null;
    }
    // autorise n√©gatif? en pratique, la lecture peut √™tre sign√©e selon m√©thode,
    // mais pour "√©cart", on veut souvent la magnitude. Ici: on garde la valeur telle quelle,
    // et on fait max/min sur la valeur num√©rique.
    let maxKey=null, minKey=null;
    let max=-Infinity, min=Infinity;

    for(const [k,v] of Object.entries(vals)){
      if(v > max){ max=v; maxKey=k; }
      if(v < min){ min=v; minKey=k; }
    }
    const delta = max - min;

    return { vals, max, min, delta, maxKey, minKey };
  }

  function refreshSoftFootKPI(){
    const r = softFootCompute();
    const box = $("sfKPI");
    if(!r){
      box.innerHTML = `<div><b>Œî (max-min)</b> : ‚Äî</div><div><b>Patte max</b> : ‚Äî</div><div><b>Patte min</b> : ‚Äî</div>`;
      return;
    }
    box.innerHTML = `
      <div><b>Œî (max-min)</b> : ${r.delta.toFixed(2)} mils</div>
      <div><b>Patte max</b> : ${r.maxKey} (${r.max.toFixed(2)})</div>
      <div><b>Patte min</b> : ${r.minKey} (${r.min.toFixed(2)})</div>
    `;
  }

  ["sfFL","sfFR","sfRL","sfRR"].forEach(id=>{
    $(id).addEventListener("input", () => {
      refreshSoftFootKPI();
      drawAlignmentView();
    });
  });

  $("btnStep2").addEventListener("click", () => {
    const r = softFootCompute();
    if(!r){
      setStatus(2, "bad", "‚ùå Entre les 4 lectures de pattes (mils).");
      return;
    }

    state.sfDelta = r.delta;
    state.sfMaxKey = r.maxKey;
    state.sfMinKey = r.minKey;

    if(r.delta <= TOL.softFoot){
      state.softFootOK = true;
      state.step = Math.max(state.step, 3);
      setStatus(2, "ok", `‚úî Pied boiteux acceptable: Œî=${r.delta.toFixed(2)} mils (‚â§ ${TOL.softFoot.toFixed(1)}).`);
      unlock(3);
    }else{
      state.softFootOK = false;
      setStatus(2, "bad", `‚õî Pied boiteux pr√©sent: Œî=${r.delta.toFixed(2)} mils (> ${TOL.softFoot.toFixed(1)}). Corriger AVANT l‚Äôalignement.`);
      // On bloque la suite tant que pas OK
      lock(3); lock(4); lock(5); lock(6);
    }

    drawAlignmentView();
    setPills();
  });

  /* ===================== STEP 3 (ANG V) ===================== */
  function computeDelta(a, b){ return a - b; }

  function refreshAngVKPI(){
    const a = parseNum("v12");
    const b = parseNum("v6");
    const box = $("kpiAngV");
    if(a === null || b === null){
      box.innerHTML = `<div><b>ŒîV</b> (12h‚àí6h): ‚Äî</div>`;
      return;
    }
    const d = computeDelta(a,b);
    box.innerHTML = `<div><b>ŒîV</b> (12h‚àí6h): ${d.toFixed(2)} mils</div>`;
  }

  ["v12","v6"].forEach(id=>{
    $(id).addEventListener("input", () => {
      refreshAngVKPI();
      drawAlignmentView();
    });
  });

  $("btnStep3").addEventListener("click", () => {
    const a = parseNum("v12");
    const b = parseNum("v6");
    if(a === null || b === null){
      setStatus(3, "bad", "‚ùå Entre les lectures 12h et 6h (mils).");
      return;
    }

    const d = computeDelta(a,b);
    state.angVDelta = d;

    if(Math.abs(d) <= TOL.angDelta){
      state.angVOK = true;
      state.step = Math.max(state.step, 4);
      setStatus(3, "ok", `‚úî Angularit√© V acceptable: ŒîV=${d.toFixed(2)} mils (|Œî| ‚â§ ${TOL.angDelta.toFixed(1)}).`);
      unlock(4);
    }else{
      state.angVOK = false;
      setStatus(3, "bad", `‚õî Angularit√© V hors tol√©rance: ŒîV=${d.toFixed(2)} mils (cible |Œî| ‚â§ ${TOL.angDelta.toFixed(1)}).`);
      lock(4); lock(5); lock(6);
    }

    drawAlignmentView();
    setPills();
  });

  /* ===================== STEP 4 (PAR V) ===================== */
  $("btnStep4").addEventListener("click", () => {
    const v = parseNum("parV");
    const tol = parseNum("tolParV");

    if(v === null || tol === null){
      setStatus(4, "bad", "‚ùå Entre la lecture et la tol√©rance (mils).");
      return;
    }
    state.parV = v;

    if(Math.abs(v) <= Math.abs(tol)){
      state.parVOK = true;
      state.step = Math.max(state.step, 5);
      setStatus(4, "ok", `‚úî Parall√©lisme V acceptable: ${v.toFixed(2)} mils (‚â§ ${Math.abs(tol).toFixed(2)}).`);
      unlock(5);
    }else{
      state.parVOK = false;
      setStatus(4, "bad", `‚õî Parall√©lisme V hors tol√©rance: ${v.toFixed(2)} mils (cible ‚â§ ${Math.abs(tol).toFixed(2)}).`);
      lock(5); lock(6);
    }

    drawAlignmentView();
    setPills();
  });

  /* ===================== STEP 5 (ANG H) ===================== */
  function refreshAngHKPI(){
    const a = parseNum("h3");
    const b = parseNum("h9");
    const box = $("kpiAngH");
    if(a === null || b === null){
      box.innerHTML = `<div><b>ŒîH</b> (3h‚àí9h): ‚Äî</div>`;
      return;
    }
    const d = computeDelta(a,b);
    box.innerHTML = `<div><b>ŒîH</b> (3h‚àí9h): ${d.toFixed(2)} mils</div>`;
  }

  ["h3","h9"].forEach(id=>{
    $(id).addEventListener("input", () => {
      refreshAngHKPI();
      drawAlignmentView();
    });
  });

  $("btnStep5").addEventListener("click", () => {
    const a = parseNum("h3");
    const b = parseNum("h9");
    if(a === null || b === null){
      setStatus(5, "bad", "‚ùå Entre les lectures 3h et 9h (mils).");
      return;
    }

    const d = computeDelta(a,b);
    state.angHDelta = d;

    if(Math.abs(d) <= TOL.angDelta){
      state.angHOK = true;
      state.step = Math.max(state.step, 6);
      setStatus(5, "ok", `‚úî Angularit√© H acceptable: ŒîH=${d.toFixed(2)} mils (|Œî| ‚â§ ${TOL.angDelta.toFixed(1)}).`);
      unlock(6);
    }else{
      state.angHOK = false;
      setStatus(5, "bad", `‚õî Angularit√© H hors tol√©rance: ŒîH=${d.toFixed(2)} mils (cible |Œî| ‚â§ ${TOL.angDelta.toFixed(1)}).`);
      lock(6);
    }

    drawAlignmentView();
    setPills();
  });

  /* ===================== STEP 6 (PAR H) ===================== */
  $("btnStep6").addEventListener("click", () => {
    const v = parseNum("parH");
    const tol = parseNum("tolParH");

    if(v === null || tol === null){
      setStatus(6, "bad", "‚ùå Entre la lecture et la tol√©rance (mils).");
      return;
    }
    state.parH = v;

    if(Math.abs(v) <= Math.abs(tol)){
      state.parHOK = true;
      setStatus(6, "ok", `‚úî Parall√©lisme H acceptable: ${v.toFixed(2)} mils (‚â§ ${Math.abs(tol).toFixed(2)}).`);
    }else{
      state.parHOK = false;
      setStatus(6, "bad", `‚õî Parall√©lisme H hors tol√©rance: ${v.toFixed(2)} mils (cible ‚â§ ${Math.abs(tol).toFixed(2)}).`);
    }

    drawAlignmentView();
    setPills();
  });

  /* ===================== RESET ===================== */
  $("btnResetAll").addEventListener("click", () => {
    // inputs
    ["runoutMotor","runoutPump","sfFL","sfFR","sfRL","sfRR","v12","v6","parV","h3","h9","parH"].forEach(id=>{
      if($(id)) $(id).value = "";
    });
    $("tolParV").value = "2.0";
    $("tolParH").value = "2.0";

    // state
    state.step = 1;
    state.runoutOK = state.softFootOK = state.angVOK = state.parVOK = state.angHOK = state.parHOK = false;
    state.sfDelta = state.sfMaxKey = state.sfMinKey = null;
    state.angVDelta = state.angHDelta = null;
    state.parV = state.parH = null;

    // locks
    unlock(1);
    lock(2); lock(3); lock(4); lock(5); lock(6);

    // statuses
    for(let i=1;i<=6;i++) setStatus(i, "", "");

    refreshSoftFootKPI();
    refreshAngVKPI();
    refreshAngHKPI();

    drawAlignmentView();
    setPills();
  });

  /* ===================== CANVAS VIEW ===================== */
  const alignCanvas = $("alignView");
  const alignCtx = alignCanvas.getContext("2d");

  function dprNow(){ return Math.min(3, window.devicePixelRatio || 1); }

  function resizeAlignView(){
    const dpr = dprNow();
    const w = alignCanvas.clientWidth || 1;
    const h = alignCanvas.clientHeight || 1;
    alignCanvas.width  = Math.round(w * dpr);
    alignCanvas.height = Math.round(h * dpr);
    alignCtx.setTransform(dpr,0,0,dpr,0,0);
  }

  function drawMachine(x, y, w, h, color, label){
    // corps
    alignCtx.fillStyle = color;
    alignCtx.fillRect(x, y, w, h);

    // pattes (4)
    const footW = 18, footH = 9;
    // bas
    alignCtx.fillRect(x+12,    y+h, footW, footH);
    alignCtx.fillRect(x+w-30,  y+h, footW, footH);
    // haut (visuel)
    alignCtx.fillRect(x+12,    y-9, footW, footH);
    alignCtx.fillRect(x+w-30,  y-9, footW, footH);

    // label
    alignCtx.fillStyle = "#eaf1ff";
    alignCtx.font = "12px Arial";
    alignCtx.textAlign = "center";
    alignCtx.fillText(label, x+w/2, y-14);
  }

  function drawCoupling(x1, x2, y){
    alignCtx.strokeStyle = "rgba(255,255,255,.65)";
    alignCtx.lineWidth = 3;
    alignCtx.beginPath();
    alignCtx.moveTo(x1, y);
    alignCtx.lineTo(x2, y);
    alignCtx.stroke();

    // demi-accouplement
    alignCtx.fillStyle = "rgba(255,255,255,.25)";
    alignCtx.fillRect((x1+x2)/2 - 8, y-10, 16, 20);
  }

  function drawIndicator(text, x, y, cls){
    let col = "rgba(255,255,255,.85)";
    if(cls==="ok") col = "rgba(76,175,80,.95)";
    if(cls==="bad") col = "rgba(255,82,82,.95)";
    if(cls==="warn") col = "rgba(255,179,0,.95)";

    alignCtx.fillStyle = "rgba(0,0,0,.45)";
    alignCtx.fillRect(x-62, y-14, 124, 22);

    alignCtx.fillStyle = col;
    alignCtx.font = "12px Arial";
    alignCtx.textAlign = "center";
    alignCtx.textBaseline = "middle";
    alignCtx.fillText(text, x, y-3);
  }

  function drawAlignmentView(){
    resizeAlignView();

    const dpr = dprNow();
    const W = alignCanvas.width / dpr;
    const H = alignCanvas.height / dpr;

    // fond
    alignCtx.clearRect(0,0,W,H);
    alignCtx.fillStyle = "#000";
    alignCtx.fillRect(0,0,W,H);

    // dimensions machines
    const machineW = Math.min(140, Math.max(110, W*0.32));
    const machineH = 54;
    const centerY = H/2 - machineH/2;

    // positions
    const leftX  = 18;
    const rightX = W - machineW - 18;

    // machines
    drawMachine(leftX, centerY, machineW, machineH, "#00a2ff", "Moteur (mobile)");
    drawMachine(rightX, centerY, machineW, machineH, "#ff9800", "Pompe (fixe)");

    // accouplement
    const shaftY = centerY + machineH/2;
    drawCoupling(leftX + machineW, rightX, shaftY);

    // indicateurs (p√©dago)
    if(!state.runoutOK){
      drawIndicator("Voilage √† valider", W/2, 26, "warn");
    }else{
      drawIndicator("Voilage OK", W/2, 26, "ok");
    }

    // Soft foot indicator
    if(state.runoutOK){
      if(state.softFootOK){
        drawIndicator("Pied boiteux OK", leftX + machineW/2, H - 18, "ok");
      }else{
        // si on a des donn√©es, afficher Œî
        if(isNum(state.sfDelta)){
          drawIndicator("Pied boiteux Œî=" + state.sfDelta.toFixed(2), leftX + machineW/2, H - 18, (state.sfDelta<=TOL.softFoot)?"ok":"bad");
        }else{
          drawIndicator("Pied boiteux √† mesurer", leftX + machineW/2, H - 18, "warn");
        }
      }
    }

    // Ang V/H indicators
    if(state.angVOK && isNum(state.angVDelta)){
      drawIndicator("Ang V Œî=" + state.angVDelta.toFixed(2), W/2, 54, "ok");
    }else if(isNum(state.angVDelta)){
      drawIndicator("Ang V Œî=" + state.angVDelta.toFixed(2), W/2, 54, "bad");
    }

    if(state.angHOK && isNum(state.angHDelta)){
      drawIndicator("Ang H Œî=" + state.angHDelta.toFixed(2), W/2, 80, "ok");
    }else if(isNum(state.angHDelta)){
      drawIndicator("Ang H Œî=" + state.angHDelta.toFixed(2), W/2, 80, "bad");
    }

    // Parallel indicators
    if(state.parVOK && isNum(state.parV)){
      drawIndicator("Par V=" + state.parV.toFixed(2), rightX + machineW/2, H - 18, "ok");
    }else if(isNum(state.parV)){
      drawIndicator("Par V=" + state.parV.toFixed(2), rightX + machineW/2, H - 18, "bad");
    }

    if(state.parHOK && isNum(state.parH)){
      drawIndicator("Par H=" + state.parH.toFixed(2), W/2, H - 44, "ok");
    }else if(isNum(state.parH)){
      drawIndicator("Par H=" + state.parH.toFixed(2), W/2, H - 44, "bad");
    }
  }

  /* ===================== INIT ===================== */
  function handleResize(){
    drawAlignmentView();
  }
  window.addEventListener("resize", handleResize);
  if(window.visualViewport){
    window.visualViewport.addEventListener("resize", handleResize);
  }

  // init locks
  lock(2); lock(3); lock(4); lock(5); lock(6);

  refreshSoftFootKPI();
  refreshAngVKPI();
  refreshAngHKPI();
  drawAlignmentView();
  setPills();
})();
</script>

</body>
</html>